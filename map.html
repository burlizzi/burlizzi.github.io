<!DOCTYPE html>
<html>
<head>
    <title>Mappa con Timeline</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        #map { height: 600px; }
        .leaflet-marker-icon.label {
            background: transparent;
            border: none;
        }
        .time-label {
            font-size: 12px;
            color: #fff;
            background: #333;
            padding: 2px 5px;
            border-radius: 3px;
            white-space: nowrap;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        const map = L.map('map').setView([45.4642, 9.1900], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        async function loadTrackData() {
            try {
                const response = await fetch('https://xtogeso2mwuprwi46kp7mf4t6m0drfoj.lambda-url.eu-west-1.on.aws/?id=6801d638-0000-2353-a061-14c14ef7b930&name=Portafoglio');
                const data = await response.json();
                
                if(!Array.isArray(data)) throw new Error("Formato dati non valido");
                
                // Crea polilinea
                const coordinates = data.map(p => [p.lat, p.lon]);
                L.polyline(coordinates, {color: 'blue'}).addTo(map);

                // Aggiungi marcatori con etichette temporali
                data.forEach(point => {
                    const timestamp = new Date(point.time);
                    const timeString = timestamp.toLocaleTimeString([], { 
                        day: '2-digit', 
                        hour: '2-digit', 
                        minute: '2-digit',
                        hour12: false
                    });

                    // Crea icona personalizzata con etichetta
                    const labelIcon = L.divIcon({
                        className: 'label',
                        html: `<div class="time-label">${timeString}</div>`,
                        iconSize: [60, 20],
                        iconAnchor: [30, 10]
                    });

                    // Crea marker con popup e icona
                    L.marker([point.lat, point.lon], {
                        icon: labelIcon
                    }).bindPopup(`
                        <b>${timestamp.toLocaleString()}</b><br>
                        Lat: ${point.lat.toFixed(4)}<br>
                        Lon: ${point.lon.toFixed(4)}
                    `).addTo(map);
                });

                // Centra la mappa sulla traccia
                const bounds = L.latLngBounds(coordinates);
                map.fitBounds(bounds);

            } catch (error) {
                console.error('Errore:', error);
                alert('Errore nel caricamento dei dati');
            }
        }

        loadTrackData();
    </script>
</body>
</html>
